<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Particle Text Morph</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>

<style>
body {
  margin: 0;
  background: black;
  overflow: hidden;
}
input {
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  padding: 12px 20px;
  font-size: 20px;
  color: #00ffd5;
  background: black;
  border: 2px solid #00ffd5;
  box-shadow: 0 0 20px #00ffd5;
  outline: none;
}
</style>
</head>

<body>
<input id="txt" placeholder="Type..." />

<script>
let particles = [];
let targets = [];
let mode = "sphere";

function setup() {
  createCanvas(windowWidth, windowHeight);
  pixelDensity(1);

  for (let i = 0; i < 1800; i++) {
    particles.push(new Particle());
  }
}

function draw() {
  background(0, 50);

  for (let p of particles) {
    if (mode === "sphere") p.sphere();
    else p.followText();

    p.update();
    p.show();
  }
}

/* ================= TEXT TO PARTICLES ================= */

function buildText(word) {
  targets = [];

  // Canvas مخفي لرسم النص
  let gfx = createGraphics(width, height);
  gfx.pixelDensity(1);
  gfx.background(0);
  gfx.fill(255);
  gfx.textAlign(CENTER, CENTER);
  gfx.textSize(180);
  gfx.text(word, width / 2, height / 2);
  gfx.loadPixels();

  // استخراج نقاط من البيكسلز
  for (let x = 0; x < width; x += 6) {
    for (let y = 0; y < height; y += 6) {
      let idx = (x + y * width) * 4;
      if (gfx.pixels[idx] > 0) {
        targets.push(createVector(x, y));
      }
    }
  }

  // ربط النقاط بالجسيمات
  for (let i = 0; i < particles.length; i++) {
    if (targets[i]) {
      particles[i].target = targets[i];
      particles[i].active = true;
    } else {
      particles[i].active = false;
    }
  }
}

/* ================= INPUT ================= */

document.getElementById("txt").addEventListener("input", e => {
  if (e.target.value.length > 0) {
    mode = "text";
    buildText(e.target.value);
  } else {
    mode = "sphere";
    particles.forEach(p => p.active = true);
  }
});

/* ================= PARTICLE ================= */

class Particle {
  constructor() {
    this.pos = createVector(random(width), random(height));
    this.vel = p5.Vector.random2D();
    this.acc = createVector();
    this.angle = random(TWO_PI);
    this.radius = random(160, 260);
    this.target = createVector(width / 2, height / 2);
    this.active = true;
  }

  sphere() {
    this.angle += 0.01;
    let x = width / 2 + cos(this.angle) * this.radius;
    let y = height / 2 + sin(this.angle) * this.radius;
    this.seek(createVector(x, y), 0.6);
  }

  followText() {
    if (this.active) {
      this.seek(this.target, 1);
    }
  }

  seek(target, forceLimit) {
    let desired = p5.Vector.sub(target, this.pos);
    let d = desired.mag();
    let speed = map(d, 0, 300, 0, 12);
    desired.setMag(speed);
    let steer = p5.Vector.sub(desired, this.vel);
    steer.limit(forceLimit);
    this.acc.add(steer);
  }

  update() {
    this.vel.add(this.acc);
    this.pos.add(this.vel);
    this.acc.mult(0);
  }

  show() {
    if (!this.active) return;
    stroke(0, 255, 200);
    strokeWeight(2);
    point(this.pos.x, this.pos.y);
  }
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}
</script>
</body>
</html>
